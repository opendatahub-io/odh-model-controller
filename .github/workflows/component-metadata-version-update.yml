name: Update Component Metadata Version

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'The component for which the version metadata will be updated'
        required: true
        type: choice
        options:
          - KServe
          - vLLM
          - OpenVINO Model Server
          - MLServer
          - Caikit
          - Caikit-nlp
          - Text Generation Inference Server
      component_version:
        description: "The version which the selected component's metadata will be updated to reflect"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-component-version:
    name: Update Component Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Update component version in metadata
        run: |
          import os
          import re

          component = "${{ github.event.inputs.component }}"
          component_version = "${{ github.event.inputs.component_version }}"

          print(f"Updating component: {component}")
          print(f"New version: {component_version}\n")

          file_path = "config/component_metadata.yaml"

          if not os.path.exists(file_path):
            print(f"✗ Component metadata file {file_path} not found")
            exit(1)

          try:
            with open(file_path, 'r') as f:
              content = f.read()

            # Pattern to match the component's version field
            # This will match the version line following the component name
            # Example:
            #   - name: KServe
            #     version: v0.14.0
            pattern = re.compile(
              rf"(- name: {re.escape(component)}\s+version:\s+).*",
              re.MULTILINE
            )

            # Check if pattern exists
            if not pattern.search(content):
              print(f"✗ Component '{component}' not found in {file_path}")
              exit(1)

            # Replace with new version
            updated_content = pattern.sub(
              rf"\g<1>{component_version}",
              content
            )

            # Write back if content changed
            if updated_content != content:
              with open(file_path, 'w') as f:
                f.write(updated_content)

              print(f"✓ Updated {component} version to '{component_version}' in {file_path}")
            else:
              print(f"- {component} already at version '{component_version}' in {file_path}")

          except Exception as e:
            print(f"✗ Error processing version update for component {component} in {file_path}: {str(e)}")
            exit(1)

          print(f"\n✓ Component metadata update complete")
        shell: python

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Configure git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "Version Update Bot"

          # Stage component metadata file
          git add config/component_metadata.yaml 2>/dev/null || true

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit"
            exit 0
          fi

          # Create a new branch for the PR
          BRANCH_NAME="chore/update-${{ github.event.inputs.component }}-component-metadata-version-to-${{ github.event.inputs.component_version }}"
          # Replace spaces with hyphens in branch name
          BRANCH_NAME=$(echo "$BRANCH_NAME" | tr ' ' '-')
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git commit -m "chore(metadata): Update ${{ github.event.inputs.component }} version to ${{ github.event.inputs.component_version }}"

          # Force push the branch (handles both new and existing branches)
          git push --force-with-lease origin "$BRANCH_NAME"
          echo "✓ Branch pushed: $BRANCH_NAME"

          # Create PR
          PR_URL=$(gh pr create \
            --base ${{ github.ref_name }} \
            --head "$BRANCH_NAME" \
            --title "chore(metadata): Update ${{ github.event.inputs.component }} version to ${{ github.event.inputs.component_version }}" \
            --body "## Summary

          This PR updates the version metadata for **${{ github.event.inputs.component }}** to \`${{ github.event.inputs.component_version }}\` in the component metadata file.

          - **Component:** \`${{ github.event.inputs.component }}\`
          - **New Version:** \`${{ github.event.inputs.component_version }}\`

          ---
          *This PR was automatically created by the Component Metadata Version Update Workflow.*")

          echo "✓ PR created: $PR_URL"