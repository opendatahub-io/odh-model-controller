name: Create Tag and Release with Changelog

on:
  workflow_dispatch:
    inputs:
      tag_name: # The new release tag to be created and used as the search value.
        description: 'New release tag (e.g., odh-v2.35)'
        required: true
        type: string
      next_tag_name: # The next tag to replace the current one in the Konflux files.
        description: 'Next development cycle tag: (e.g., odh-v2.36)'
        required: true
        type: string
    #
    # Note: This workflow assumes the release tag and image tags are in sync.
    #       'tag_name' is used to create the release and as the value to find in konflux files.
    #       'next_tag_name' provides the new value to set.
    #

permissions:
  contents: write
  packages: write
  pull-requests: write

env:
  TAG_NAME: ${{ github.event.inputs.tag_name }}
  NEXT_TAG_NAME: ${{ github.event.inputs.next_tag_name }}
  
jobs:
  validate-tag:
    runs-on: ubuntu-latest
    if: github.ref_name == 'incubating'
    steps:
      - name: Validate tag format
        run: |
          if [[ "$TAG_NAME" == "$NEXT_TAG_NAME" ]]; then
            echo "Error: tag name and next tag name must be different (both are: $TAG_NAME)"
            exit 1
          fi
          if [[ ! "$TAG_NAME" =~ ^odh-v[0-9]+\.[0-9]+$ ]]; then
            echo "Error: tag name format invalid: $TAG_NAME (expected format: odh-vX.Y, e.g., odh-v2.35)"
            exit 1
          fi
          if [[ ! "$NEXT_TAG_NAME" =~ ^odh-v[0-9]+\.[0-9]+$ ]]; then
            echo "Error: next tag name format invalid: $NEXT_TAG_NAME (expected format: odh-vX.Y, e.g., odh-v2.36)"
            exit 1
          fi   
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      - name: Validate current tag presence in .tekton/odh-model-controller-push.yaml
        run: |
          if [[ ! -f .tekton/odh-model-controller-push.yaml ]]; then
            echo "Error: .tekton/odh-model-controller-push.yaml not found"
            exit 1
          fi
          if ! grep -q "odh-model-controller:$TAG_NAME" .tekton/odh-model-controller-push.yaml; then
            echo "Error: Tag $TAG_NAME not found in .tekton/odh-model-controller-push.yaml"
            exit 1
          fi
      - name: Validate fast tag presence in config/base/params.env
        run: |
          if [[ ! -f config/base/params.env ]]; then
            echo "Error: config/base/params.env not found"
            exit 1
          fi
          if ! grep -q "odh-model-controller:fast" config/base/params.env; then
            echo "Error: Tag odh-model-controller:fast not found in config/base/params.env"
            exit 1
          fi
          if ! grep -q "mlserver:fast" config/base/params.env; then
            echo "Error: Tag mlserver:fast not found in config/base/params.env"
            exit 1
          fi

  fetch-tag:
    runs-on: ubuntu-latest
    needs: validate-tag
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
      - name: Get latest tag
        id: get_tag
        run: |
          echo "old_tag_name=$(git for-each-ref --sort=creatordate --format '%(refname)' refs/tags  | awk -F'/' '{print $3}' | tail -n1)" >> $GITHUB_OUTPUT
      - name: Print tags
        run: | 
          echo "Old Tag=${{ steps.get_tag.outputs.old_tag_name }}"
          echo "NEW Tag=$TAG_NAME"
          echo "Next Tag=$NEXT_TAG_NAME"
          echo "$(basename ${{ github.ref }})"
      - name: Check if tag exists
        run: |
            import sys
            import subprocess
            import os
            tag_name = os.environ['TAG_NAME']
            command = ['git', 'tag', '-l', tag_name]
            output = subprocess.check_output(command, stderr=subprocess.STDOUT)
            if output.decode() != "":
                print(f"Error: Tag '{tag_name}' already exists.", file=sys.stderr)
                sys.exit(1)
            else:
                print(f"Tag '{tag_name}' does not exist.")
        shell: python
        continue-on-error: false

  create-tag:
    runs-on: ubuntu-latest
    needs: fetch-tag
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}   
      - name: Update params.env with new release version
        run: |
          sed -i "s|odh-model-controller:fast|odh-model-controller:$TAG_NAME|g" config/base/params.env
          sed -i "s|mlserver:fast|mlserver:$TAG_NAME|g" config/base/params.env
      - name: Commit changes
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "Release Bot"
          git add config/base/params.env
          git commit -m "Update image refs for release."
      - name: Create Tag
        run: |
          git tag -a $TAG_NAME -m "Release $TAG_NAME"
          git push origin $TAG_NAME

  changelog:
    runs-on: ubuntu-latest
    needs: create-tag
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      - name: Create release and changelog
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          tag_name: ${{ env.TAG_NAME }}
          prerelease: false
          draft: false
          # this takes the path of payload to upload as an asset in the changelog
          files: bin/*
          generate_release_notes: true
          name: ${{ env.TAG_NAME }}
  
  bump-tag: 
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      - name: Update odh-model-controller-push.yaml with next tag
        run: |
          echo "Updating odh-model-controller image tag from $TAG_NAME to $NEXT_TAG_NAME in .tekton/odh-model-controller-push.yaml..."
          
          sed -i "s|odh-model-controller:$TAG_NAME|odh-model-controller:$NEXT_TAG_NAME|g" .tekton/odh-model-controller-push.yaml

          echo "Update complete."
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if there are any changes to commit
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit. Exiting."
          else
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "Release Bot"

            # Create a new branch for the PR
            BRANCH_NAME="bump-tag-$NEXT_TAG_NAME"
            git checkout -b "$BRANCH_NAME"

            # Stage and commit changes
            git add .tekton/odh-model-controller-push.yaml
            git commit -m "chore(konflux): Bump release tag to $NEXT_TAG_NAME"
            git push -u origin "$BRANCH_NAME"

            # Create pull request using GitHub CLI
            gh pr create \
              --title "chore(konflux): Bump release tag to $NEXT_TAG_NAME" \
              --body "$(cat <<EOF
          ## Description
          - Updated image tag reference in Konflux configuration
          - Part of the release preparation workflow for $TAG_NAME

          ## Changes
          - Release tag updated from \`$TAG_NAME\` to \`$NEXT_TAG_NAME\` in \`.tekton/odh-model-controller-push.yaml\`

          ðŸ¤– Generated with GitHub Actions
          EOF
          )" \
              --base ${{ github.ref_name }} \
              --head "$BRANCH_NAME"
          fi