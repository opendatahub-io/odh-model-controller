name: Create Tag and Release with Changelog

on:
  workflow_dispatch:
    inputs:
      tag_name: # The new release tag to be created and used as the search value.
        description: 'New release tag (e.g., odh-v2.35)'
        required: true
        type: string
      next_odh_tag: # The next ODH tag to replace the current one in the Konflux files.
        description: 'Next development cycle tag: (e.g., odh-v2.36)'
        required: true
        type: string
    #
    # Note: This workflow assumes the release tag and image tags are in sync.
    #       'tag_name' is used to create the release and as the value to find in konflux files.
    #       'next_odh_tag' provides the new value to set.
    #

permissions:
  contents: write
  packages: write
  pull-requests: write
  
jobs:
  fetch-tag:
    runs-on: ubuntu-latest
    outputs:
      old_tag: ${{ steps.get_tag.outputs.old_tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
      
      - name: Get latest tag
        id: get_tag
        run: |
          echo "old_tag_name=$(git for-each-ref --sort=creatordate --format '%(refname)' refs/tags  | awk -F'/' '{print $3}' | tail -n1)" >> $GITHUB_OUTPUT
      - name: print tag
        id: print_tag
        run: | 
          echo "Old Tag=${{ steps.get_tag.outputs.old_tag_name }}"
          echo "NEW_TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_ENV
          echo "$(basename ${{ github.ref }})"

      - name: Check if tag exists
        id: check_tag
        run: |
         import sys
         import subprocess
         tag_name = "${{ github.event.inputs.tag_name }}"
         command = ['git', 'tag', '-l', tag_name]
         output = subprocess.check_output(command, stderr=subprocess.STDOUT)
         if output.decode() != "":
           print(f"Error: Tag '{tag_name}' already exists.", file=sys.stderr)
           sys.exit(1)
         else:
           print(f"Tag '{tag_name}' does not exists.")
        
        shell: python
        continue-on-error: false

#this works only if params.env contains image:tag_version_number
  update-params-env:
    runs-on: ubuntu-latest
    needs: fetch-tag
    outputs:
      param_env: ${{ steps.read_params_env.outputs.params_env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
              
      - name: Update params.env with new release version
        run: | 
          sed -i 's|odh-model-controller:fast|odh-model-controller:${{ github.event.inputs.tag_name }}|gm' config/base/params.env
      - name: Commit changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add config/base/params.env
          git commit -m "Update image refs for odh release."

      - name: Create Tag
        id: create_tag
        run: |
          git tag -a ${{ github.event.inputs.tag_name }} -m "Prepare for ODH release ${{ github.event.inputs.tag_name }}"
          git push origin ${{ github.event.inputs.tag_name }}

  changelog:
    name: Changelog
    needs: [fetch-tag,update-params-env]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ github.token }}
          tag_name: ${{ github.event.inputs.tag_name }}
          prerelease: false
          draft: false
    #this takes the path of payload to upload as an asset in the changelog
          files: bin/*
          generate_release_notes: true
          name: ${{ github.event.inputs.tag_name }}
  
  # This job updates the ODH tag in the specified file and commits the change
  bump-odh-tag: 
    name: Bump ODH Tag for Next Release
    runs-on: ubuntu-latest
    needs: [fetch-tag, update-params-env, changelog]
    permissions:
      contents: write # Re-adding to ensure write permission.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }} # This will resolve the detached HEAD issue that code rabbit brought up.
      
      - name: Update odh-model-controller-push.yaml with next ODH tag
        run: |
          CURRENT_TAG="${{ github.event.inputs.tag_name }}"
          NEXT_TAG="${{ github.event.inputs.next_odh_tag }}"
          
          echo "Updating ODH tag from $CURRENT_TAG to $NEXT_TAG..."
          
          # Using sed to replace the current ODH tag with the next one,
          # anchored to the image name to prevent over-matching.
          sed -i "s|odh-model-controller:${CURRENT_TAG}|odh-model-controller:${NEXT_TAG}|g" .tekton/odh-model-controller-push.yaml

          echo "Update complete."
          
      - name: Commit and Push Changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .tekton/odh-model-controller-push.yaml
          
          # Check if there are any changes to commit
          if [[ -z "$(git status --porcelain)" ]]; then 
            echo "No changes to commit. Exiting."
          else
            git commit -m "chore(konflux): Bump ODH release tag to ${{ github.event.inputs.next_odh_tag }}"
            git push
          fi