apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: onnx-mnist-splitting
  namespace: ns-dssnm
  annotations:
    serving.kserve.io/model-tag: onnx-mnist
spec:
  gateways:
  - opendatahub/odh-gateway
  hosts:
  - '*'
  http:
  - name: grpc-routing
    match:
    - method:
        exact: POST
      headers:
        content-type:
          prefix: application/grpc
        mm-vmodel-id:
          exact: onnx-mnist
    route:
    - destination:
        host: modelmesh-serving.ns-dssnm.svc.cluster.local
        port:
          number: 8033
      headers:
        request:
          set:
            mm-vmodel-id: example-onnx-mnist-v1
      weight: 50
    - destination:
        host: modelmesh-serving.ns-dssnm.svc.cluster.local
        port:
          number: 8033
      headers:
        request:
          set:
            mm-vmodel-id: example-onnx-mnist-v2
      weight: 50
  - match:
    - uri:
        exact: /modelmesh/ns-dssnm/v2/models/onnx-mnist/infer
    rewrite:
      uri: /vmodel-route/ns-dssnm/onnx-mnist/infer
    route:
    - destination:
        host: istio-ingressgateway.istio-system.svc.cluster.local
        port:
          number: 80
      headers:
        request:
          set:
            x-vmodel: example-onnx-mnist-v1
      weight: 50
    - destination:
        host: istio-ingressgateway.istio-system.svc.cluster.local
        port:
          number: 80
      headers:
        request:
          set:
            x-vmodel: example-onnx-mnist-v2
      weight: 50
  - match:
    - uri:
        exact: /vmodel-route/ns-dssnm/onnx-mnist/infer
      headers:
        x-vmodel:
          exact: example-onnx-mnist-v1
    rewrite:
      uri: /v2/models/example-onnx-mnist-v1/infer
    route:
      - destination:
          host: modelmesh-serving.ns-dssnm.svc.cluster.local
          port:
            number: 8008
  - match:
    - uri:
        exact: /vmodel-route/ns-dssnm/onnx-mnist/infer
      headers:
        x-vmodel:
          exact: example-onnx-mnist-v2
    rewrite:
      uri: /v2/models/example-onnx-mnist-v2/infer
    route:
      - destination:
          host: modelmesh-serving.ns-dssnm.svc.cluster.local
          port:
            number: 8008